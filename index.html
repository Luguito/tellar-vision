<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR Three</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>
    
    <script type="importmap">
      {
        "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-face-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-three.prod.js"
        }
      }
      </script>
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-face-three';

        var stats;
        var params = {
            snowfall: 2
        };
        var meshList = [];
        var frame = 3;
        const mindarThree = new MindARThree({
            container: document.querySelector("#container"),
        });

        const { renderer, scene, camera } = mindarThree;

        // Agregar luz
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);

        const headModel = new THREE.Object3D(); // Objeto 3D que actuará como modelo de cabeza
        scene.add(headModel);
        // Agregar faceMesh
        const faceMesh = mindarThree.addFaceMesh();
        headModel.add(faceMesh);

        // Textura del filtro
        const textureLoader = new THREE.TextureLoader()
        const texture = textureLoader.load('http://localhost:3000/last-filter.png');
        const topLeftLogoTexture = textureLoader.load('http://localhost:3000/logo_brand.png');
        const bottomCenterLogoTexture = textureLoader.load('http://localhost:3000/name-brand.png');

        const topLeftLogo = new THREE.Mesh(
            new THREE.PlaneGeometry(0.15, 0.15),
            new THREE.MeshBasicMaterial({ map: topLeftLogoTexture, transparent: true })
        );

        const bottomCenterLogo = new THREE.Mesh(
            new THREE.PlaneGeometry(0.4, 0.1),
            new THREE.MeshBasicMaterial({ map: bottomCenterLogoTexture, transparent: true })
        );

        topLeftLogo.position.set(-0.42, 0.17, -1);
        bottomCenterLogo.position.set(0, -0.16, -1);


        scene.add(topLeftLogo);
        scene.add(bottomCenterLogo);

        faceMesh.material.map = texture;
        faceMesh.material.transparent = true;
        faceMesh.material.needsUpdate = true;

        // // Función para ajustar posiciones responsivas
        // const updateLogoPositions = () => {
        //     const aspect = window.innerWidth / window.innerHeight; // Relación de aspecto de la ventana

        //     // Ajustar posiciones en función del aspecto
        //     topLeftLogo.position.set(-aspect, 0.1, -1); // Esquina superior izquierda
        //     bottomCenterLogo.position.set(0, -0.1, -1); // Centro inferior
        // };

        // // Escuchar cambios en el tamaño de la ventana
        // window.addEventListener('resize', () => {
        //     // Actualizar tamaño del renderizador y cámara
        //     renderer.setSize(window.innerWidth, window.innerHeight);
        //     camera.aspect = window.innerWidth / window.innerHeight;
        //     camera.updateProjectionMatrix();

        //     // Actualizar posiciones de los logos
        //     updateLogoPositions();
        // });

        // // Llamar inicialmente para configurar las posiciones
        // updateLogoPositions();

        



        function getRandom(min, max) {
            return Math.random() * (max - min) + min;
        }

        class SnowFlakes extends THREE.Object3D {
            constructor() {
                super();
                this.snowList = [];
                this.angle = 0;

                var length = params.snowfall; //雪の数

                var geometry = new THREE.BufferGeometry();

                var materials = [];

                var textureLoader = new THREE.TextureLoader();
                var sprite1 = textureLoader.load('https://dl.dropbox.com/s/13ec3ht27adnu1l/snowflake1.png?dl=0');
                var sprite2 = textureLoader.load('https://dl.dropbox.com/s/rczse8o8zt5mxe6/snowflake2.png?dl=0');
                var sprite3 = textureLoader.load('https://dl.dropbox.com/s/cs17pph4bu096k7/snowflake3.png?dl=0');
                var sprite4 = textureLoader.load('https://dl.dropbox.com/s/plwtcfvokuoz931/snowflake4.png?dl=0');
                var sprite5 = textureLoader.load('https://dl.dropbox.com/s/uhh77omqdwqo2z5/snowflake5.png?dl=0');

                var vertices = [];
                for (var i = 0; i < length; i++) {
                    var x = getRandom(0, 500);
                    var y = getRandom(0, 500);
                    var z = getRandom(0, 500);
                    vertices.push(x, y, z);
                }

                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

                var parameters = [
                    ["#FFFFFF", sprite2, getRandom(10, 10)],
                    ["#FFFFFF", sprite3, getRandom(10, 15)],
                    ["#FFFFFF", sprite1, getRandom(10, 15)],
                    ["#FFFFFF", sprite5, getRandom(5, 10)],
                    ["#FFFFFF", sprite4, getRandom(5, 10)]
                ];

                for (var i = 0; i < parameters.length; i++) {
                    var sprite = parameters[i][1];
                    var size = parameters[i][2];
                    materials[i] = new THREE.PointsMaterial({
                        size: size,
                        map: sprite,
                        blending: THREE.AdditiveBlending,
                        depthTest: false,
                        transparent: true
                    });

                    var particles = new THREE.Points(geometry, materials[i]);
                    particles.rotation.x = Math.random() * 360;
                    particles.rotation.y = Math.random() * 360;
                    particles.rotation.z = Math.random() * 360;
                    particles.vx = 0;
                    particles.vy = 0;
                    particles.material.opacity = 0;

                    this.add(particles);
                    this.snowList.push(particles);
                }
            }

            update() {
                this.angle += 0.001;

                for (var i = 0; i < this.snowList.length; i++) {
                    this.snowList[i].material.opacity += 0.01;
                    this.snowList[i].vy -= 1;
                    this.snowList[i].vx = Math.sin(this.angle) * Math.cos(this.angle) * 10;

                    this.snowList[i].vx *= 0.2;
                    this.snowList[i].vy *= 0.6;

                    this.snowList[i].position.x += this.snowList[i].vx;
                    this.snowList[i].position.y += this.snowList[i].vy;

                    if (this.snowList[i].position.y < -1000) {
                        this.snowList[i].material.opacity += 0.1;
                        this.remove(this.snowList[i]);
                        this.snowList.splice(i, 1);
                        i -= 1;
                        // console.log(this.snowList.length);
                    }
                }
            }
        }

        function tick() {
            var mesh = new SnowFlakes();
            scene.add(mesh);
            meshList.push(mesh);
            for (var i = 0; i < meshList.length; i++) {
                meshList[i].update();
            }

            renderer.render(scene, camera);
            requestAnimationFrame(tick);

            frame++;
            if (frame % 2 == 0) { return; }

            stats.update();
        }
        // Iniciar MindAR y la animación
        const start = async () => {
            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                tick()
                renderer.render(scene, camera);
            });
        };

        start();

    </script>
    <style>
        body {
            margin: 0;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
    </style>
    <!-- <script>
        document.addEventListener("DOMContentLoaded", function () {
            const list = ["glasses1", "glasses2", "hat1", "hat2", "earring"];
            const visibles = [true, false, false, true, true];
            const setVisible = (button, entities, visible) => {
                if (visible) {
                    button.classList.add("selected");
                } else {
                    button.classList.remove("selected");
                }
                entities.forEach((entity) => {
                    entity.setAttribute("visible", visible);
                });
            }
            list.forEach((item, index) => {
                const button = document.querySelector("#" + item);
                const entities = document.querySelectorAll("." + item + "-entity");
                setVisible(button, entities, visibles[index]);
                button.addEventListener('click', () => {
                    visibles[index] = !visibles[index];
                    setVisible(button, entities, visibles[index]);
                });
            });
        })
    </script>
    <style>
        body {
            margin: 0;
        }

        .example-container {
            overflow: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .options-panel {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 2;
        }

        .options-panel img {
            border: solid 2px;
            width: 50px;
            height: 50px;
            object-fit: cover;
            cursor: pointer;
        }

        .options-panel img.selected {
            border-color: green;
        }
    </style> -->
</head>

<body>
    <!-- <div class="example-container">
        <div class="options-panel">
            <img id="hat1"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/hat/thumbnail.png" />
            <img id="hat2"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/hat2/thumbnail.png" />
            <img id="glasses1"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/glasses/thumbnail.png" />
            <img id="glasses2"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/glasses2/thumbnail.png" />
            <img id="earring"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/earring/thumbnail.png" />
        </div>
        <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
            <a-assets>
                <a-asset-item id="headModel"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/sparkar/headOccluder.glb">
                </a-asset-item>
                <a-asset-item id="glassesModel"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/glasses/scene.gltf">
                </a-asset-item>
                <a-asset-item id="glassesModel2"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/glasses2/scene.gltf">
                </a-asset-item>
                <a-asset-item id="hatModel"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/hat/scene.gltf">
                </a-asset-item>
                <a-asset-item id="hatModel2"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/hat2/scene.gltf">
                </a-asset-item>
                <a-asset-item id="earringModel"
                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/earring/scene.gltf">
                </a-asset-item>
            </a-assets>
            <a-camera active="false" position="0 0 0"></a-camera>

            <a-entity mindar-face-target="anchorIndex: 168">
                <a-gltf-model mindar-face-occluder position="0 -0.3 0.15" rotation="0 0 0" scale="0.065 0.065 0.065"
                    src="#headModel"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 10">
                <a-gltf-model rotation="0 -0 0" position="0 1.0 -0.5" scale="0.35 0.35 0.35" src="#hatModel"
                    class="hat1-entity" visible="false"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 10">
                <a-gltf-model rotation="0 -0 0" position="0 -0.2 -0.5" scale="0.008 0.008 0.008" src="#hatModel2"
                    class="hat2-entity" visible="false"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 168">
                <a-gltf-model rotation="0 -0 0" position="0 0 0" scale="0.01 0.01 0.01" src="#glassesModel"
                    class="glasses1-entity" visible="false"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 168">
                <a-gltf-model rotation="0 -90 0" position="0 -0.3 0" scale="0.6 0.6 0.6" src="#glassesModel2"
                    class="glasses2-entity" visible="false"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 127">
                <a-gltf-model rotation="-0.1 -0 0" position="0 -0.3 -0.3" scale="0.05 0.05 0.05" src="#earringModel"
                    class="earring-entity" visible="false"></a-gltf-model>
            </a-entity>
            <a-entity mindar-face-target="anchorIndex: 356">
                <a-gltf-model rotation="0.1 -0 0" position="0 -0.3 -0.3" scale="0.05 0.05 0.05" src="#earringModel"
                    class="earring-entity" visible="false"></a-gltf-model>
            </a-entity>
        </a-scene>
    </div> -->
    <div id="container">
    </div>
</body>

</html>